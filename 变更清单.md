# 变更清单

本文档用于说明：本次把 EEG 情绪识别代码从“脚本式”重构为“工程化模块化”的过程中，新增/修改了哪些内容。  
（按功能模块归类，方便 code review 与团队接手。）

---

## A. 总体工程化改造（核心理念）
1. **配置驱动（YAML）**：训练不再靠改脚本，而是通过 `configs/*.yaml` 控制数据路径、预处理、模型、训练超参。
2. **统一输出结构**：所有训练都输出到 `outputs/<run>/...`，并至少包含 `metrics.json`，用于统一对比。
3. **分层职责明确**：
   - features：负责把 data 目录变成模型输入 X/y
   - preprocess：只做 fit/transform（严格 train-only fit）
   - models：只管模型结构与推理接口
   - dl/train：只管训练循环与指标/保存
   - viz：只管可视化落盘
   - scripts：只作为“薄入口”（读 config -> 调 pipeline）

---

## B. sklearn/tabular 线路
1. 新增/整理 **统一 tabular 特征入口**（从 data 目录提统计特征到 X/y）。
2. 新增 **tabular 预处理模块**（impute/scale/(可选)PCA/(可选)augmentation）。
3. 拆分 **sklearn 模型 adapter**：SVM / MLP / RandomForest 各自独立文件、统一接口（fit/predict/save/load）。
4. 新增 **统一训练脚本** `scripts/train.py`：换模型只换 yaml。
5. 新增 **统一可视化输出**：混淆矩阵图落到 `outputs/<run>/figures/`。
6. 新增 **实验汇总工具** `scripts/compare_runs.py`：
   - 扫描 `outputs/*/metrics.json` 生成 `runs_topk.csv`、`by_model.csv`、柱状图等。

---

## C. CNN/torch 线路
1. 新增 **强健多模态 npy loader**：
   - 自动处理 (N,T,F)/(N,F,T) 形状
   - y_train one-hot -> int
   - 样本数一致性检查
2. 新增 **MultiModalCVAECNN 模型模块**（可拼接 CVAE latent）。
3. 新增 **CVAE 动态加载器**：
   - checkpoint 支持 `{'model_state_dict': ...}` 或直接 state_dict
   - 支持 `py_path` 动态导入外部 `cvae_model.py`
4. 新增 **WeightedFocalLoss** 与 **类别权重策略**（含 Sad 倍数加权）。
5. 新增 **Torch KFold 训练器**：
   - 每折保存 `best_foldX.pt`
   - 最优折在 test 上评估并写 `metrics.json`
6. 新增/统一 **scheduler：CosineAnnealingWarmRestarts**（按 batch fractional epoch step）
7. 新增 `scripts/train_cnn_dl.py` + `configs/cnn.yaml` 作为 CNN 入口与模板。

---

## D. LSTM/tensorflow 线路（Step6：全量迁移 + 可视化）
1. 把原来的 4 个脚本拆分成模块：
   - feature_extraction.py -> `eeg_emotion/features/sequence/extract.py`
   - augmentation.py -> `eeg_emotion/features/sequence/augment.py`
   - model.py -> `eeg_emotion/models/tf/lstm_ae.py` + `lstm_clf.py`
   - train_lstm.py -> `scripts/train_lstm_dl.py`（薄入口 + 统一产物）
2. 新增 `eeg_emotion/preprocess/sequence.py`：sequence 预处理器（fit on train, transform test，可保存 artifacts）。
3. 修复训练中遇到的 **LearningRateSchedule + ReduceLROnPlateau 冲突**：
   - 当 classifier 使用 CosineDecay（schedule）时，自动不启用 ReduceLROnPlateau。
4. 新增可选可视化：
   - seaborn 混淆矩阵：`confusion_matrix_seaborn.png`
   - UMAP + SVM decision boundary：`umap_test_boundary_true.png`
   - 缺依赖时自动跳过，不影响训练主流程
5. 新增 `configs/lstm.yaml`：完整 pipeline 参数模板（增强、PCA、AE、mixup、分类器、viz 开关等）。

---

## E. 对协作方式的影响
1. **跑实验只改 yaml**：同学们不要在训练脚本里随意加 if/else 堆逻辑；需要新功能请新增模块文件并写一个新 yaml。
2. **outputs 不提交 git**：建议 .gitignore `outputs/`；只保留 configs 与代码。
3. **可选依赖不会阻塞主流程**：seaborn/umap 缺失只会跳过画图，训练照常输出 metrics。
